name: Build and Upload Wheels for fall detection
 
on:
  push:
    branches: [ main ]
  workflow_dispatch:
 
jobs:
  build:
    name: Build for Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
 
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.11", "3.12"]
 
    steps:
      - name: Checkout repository with LFS
        uses: actions/checkout@v4
        with:
          lfs: true         
          fetch-depth: 0
 
      - name: Verify LFS content
        run: |
          git lfs install
          git lfs pull
          echo "Listing weights directory:"
          ls -lh fall_package/weights || true
 
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
 
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel cython build
 
      - name: Build wheel
        run: python -m build . --wheel
 
      - name: Remove source files after build (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          echo "Removing .py and .c files after Cythonization..."
          find fall_package -type f \( -name "*.py" -o -name "*.c" \) -delete || true
          find build -type f \( -name "*.py" -o -name "*.c" \) -delete || true
 
      - name: Remove source files after build (Windows)
        if: runner.os == 'Windows'
        run: |
          powershell -Command "
            Write-Host 'Removing .py and .c files after Cythonization...';
            Get-ChildItem -Recurse -Include *.py,*.c -Path fall_package | Remove-Item -Force;
            if (Test-Path build) {
              Get-ChildItem -Recurse -Include *.py,*.c -Path build | Remove-Item -Force
            }
          "
 
      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: fall_package_${{ matrix.os }}_py${{ matrix.python-version }}
          path: dist/*.whl
          compression-level: 6
          overwrite: true